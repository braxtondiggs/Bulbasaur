<div id="skills" animateOnScroll class="mb-6 shadow-xl card bg-base-100 animated" animationName="fadeInUp">
  <div class="card-body">
    <h2 class="mb-6 text-3xl font-bold card-title">My "Real-Time" Coding</h2>
    <form [formGroup]="form" class="mb-6 text-center">
      <p class="mb-4 text-base-content/80">
        See exactly when & what my coding activity is using
        <a href="https://wakatime.com/" class="link link-accent">WakaTime</a>
        .
      </p>
      <div class="w-full max-w-xs mx-auto form-control">
        <select #selector formControlName="range" (change)="selectionChange($event)" class="select select-bordered">
          <option value="yesterday">Yesterday</option>
          <option value="last7days">Last 7 Days</option>
          <option value="thisweek">This Week</option>
          <option value="lastweek">Last Week</option>
          <option value="last14days">Last 14 Days</option>
          <option value="last30days">Last 30 Days</option>
          <option value="thismonth">This Month</option>
          <option value="lastmonth">Last Month</option>
          <option value="customrange">Custom Range</option>
        </select>
      </div>
      <div class="hidden">
        <input type="date" formControlName="start" (change)="dateRangeChange()" />
        <input type="date" formControlName="end" (change)="dateRangeChange()" />
      </div>
      @if (form.valid && form.value.range === 'customrange') {
        <div class="p-3 mt-4 rounded-lg bg-base-200">
          <h4 class="mb-1 text-sm font-medium text-base-content/70">Custom Date Range</h4>
          <p class="text-lg font-semibold">
            {{ form.value.start | amParse | amDateFormat: 'MMM Do YYYY' }} -
            {{ form.value.end | amParse | amDateFormat: 'MMM Do YYYY' }}
          </p>
        </div>
      }
    </form>
    <div role="tablist" class="tabs tabs-border">
      <a
        role="tab"
        class="transition-all duration-200 tab"
        [class.tab-active]="selectedTabIndex() === 0"
        (click)="selectedTabChange({ index: 0 })"
        (keydown.enter)="selectedTabChange({ index: 0 })"
        aria-label="Programming Languages"
        tabindex="0"
      >
        <span class="flex items-center gap-2">
          <ng-icon name="featherCode" size="1rem" />
          Languages
        </span>
      </a>
      <a
        role="tab"
        class="transition-all duration-200 tab"
        [class.tab-active]="selectedTabIndex() === 1"
        (click)="selectedTabChange({ index: 1 })"
        (keydown.enter)="selectedTabChange({ index: 1 })"
        aria-label="Daily Activity"
        tabindex="0"
      >
        <span class="flex items-center gap-2">
          <ng-icon name="featherActivity" size="1rem" />
          Activity
        </span>
      </a>
      <a
        role="tab"
        class="transition-all duration-200 tab"
        [class.tab-active]="selectedTabIndex() === 2"
        (click)="selectedTabChange({ index: 2 })"
        (keydown.enter)="selectedTabChange({ index: 2 })"
        aria-label="Code Editors"
        tabindex="0"
      >
        <span class="flex items-center gap-2">
          <ng-icon name="featherEdit" size="1rem" />
          Editors
        </span>
      </a>
    </div>

    <!-- Tab Content -->
    @if (selectedTabIndex() === 0) {
      <div class="p-6 relative">
        @if (isInitialLoad()) {
          <div class="flex items-center justify-center min-h-[400px]">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else {
          <!-- Refreshing indicator overlay -->
          @if (isRefreshing()) {
            <div class="absolute top-2 right-2 z-10">
              <span class="loading loading-spinner loading-sm text-accent"></span>
            </div>
          }
          <div
            class="w-full max-w-full overflow-hidden min-h-[400px] flex items-center justify-center"
            [class.opacity-75]="isRefreshing()"
            [class.transition-opacity]="isRefreshing()"
            [class.duration-300]="isRefreshing()"
          >
            <highcharts-chart
              #languagesChart
              [options]="languagesChartOptions()"
              [update]="updateFlag()"
              class="w-full h-full max-w-full"
              style="min-height: 350px; max-height: 500px"
            />
          </div>
        }
      </div>
    } @else if (selectedTabIndex() === 1) {
      <div class="p-6 relative">
        @if (isInitialLoad()) {
          <div class="flex items-center justify-center min-h-[450px]">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else {
          <!-- Refreshing indicator overlay -->
          @if (isRefreshing()) {
            <div class="absolute top-2 right-2 z-10">
              <span class="loading loading-spinner loading-sm text-accent"></span>
            </div>
          }
          <div
            class="w-full max-w-full overflow-hidden min-h-[450px] flex items-center justify-center"
            [class.opacity-75]="isRefreshing()"
            [class.transition-opacity]="isRefreshing()"
            [class.duration-300]="isRefreshing()"
          >
            <highcharts-chart
              #activityChart
              [options]="activityChartOptions()"
              [update]="updateFlag()"
              class="w-full h-full max-w-full"
              style="min-height: 400px; max-height: 500px"
            />
          </div>
        }
      </div>
    } @else if (selectedTabIndex() === 2) {
      <div class="p-6 relative">
        @if (isInitialLoad()) {
          <div class="flex items-center justify-center min-h-[400px]">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else {
          <!-- Refreshing indicator overlay -->
          @if (isRefreshing()) {
            <div class="absolute top-2 right-2 z-10">
              <span class="loading loading-spinner loading-sm text-accent"></span>
            </div>
          }
          <div
            class="w-full max-w-full overflow-hidden min-h-[400px] flex items-center justify-center"
            [class.opacity-75]="isRefreshing()"
            [class.transition-opacity]="isRefreshing()"
            [class.duration-300]="isRefreshing()"
          >
            <highcharts-chart
              #editorsChart
              [options]="editorsChartOptions()"
              [update]="updateFlag()"
              class="w-full h-full max-w-full"
              style="min-height: 350px; max-height: 500px"
            />
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Custom Date Range Modal -->
@if (showCustomRangeModal()) {
  <div
    class="z-50 modal modal-open"
    (click)="closeCustomRange()"
    (keydown.escape)="closeCustomRange()"
    tabindex="0"
    role="dialog"
    aria-label="Custom date range modal"
  >
    <div class="w-11/12 max-w-md modal-box" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" tabindex="-1">
      <h3 class="text-lg font-bold">Select Custom Date Range</h3>
      <p class="py-2 text-sm text-base-content/70">Choose a start and end date to view your coding activity for a specific period.</p>

      <form [formGroup]="form">
        <div class="py-4 space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Start Date</span>
            </label>
            <input type="date" formControlName="start" class="input input-bordered w-full" [max]="form.value.end || ''" />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">End Date</span>
            </label>
            <input type="date" formControlName="end" class="input input-bordered w-full" [min]="form.value.start || ''" [max]="today" />
          </div>

          @if (form.value.start && form.value.end) {
            <div class="p-3 rounded-lg bg-base-200">
              <div class="text-sm text-base-content/70">Selected Range:</div>
              <div class="font-semibold">
                {{ form.value.start | amParse | amDateFormat: 'MMM Do, YYYY' }} -
                {{ form.value.end | amParse | amDateFormat: 'MMM Do, YYYY' }}
              </div>
              <div class="text-xs text-base-content/60">{{ getDaysDifference() }} days</div>
            </div>
          }
        </div>
      </form>

      <div class="modal-action">
        <button type="button" class="btn btn-ghost" (click)="closeCustomRange()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="applyCustomRange()" [disabled]="!form.value.start || !form.value.end">
          Apply Range
        </button>
      </div>
    </div>
  </div>
}
